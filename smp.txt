readme
import os
import time
import platform
import re
from openpyxl import load_workbook, Workbook
from openpyxl.utils import get_column_letter
from termcolor import colored

def search_xlsx_beta(xlsx_file, search_str, result_sheet, column_offset=None, search_offset=None, print_algoName=None, date_calc=None, filter_sheetname=None, debug=False):
    start_time = time.time()

    try:
        wb = load_workbook(xlsx_file, read_only=True, data_only=True)
    except PermissionError:
        print(f"Permission denied to open file {xlsx_file}")
        return

    if debug:
        print(f"To open file: {xlsx_file} took: {round(time.time() - start_time, 2)} seconds")

    printed_filename = False
    algoName = None

    search_strings = [s.strip().lower() for s in search_str.split(",")]
    column_offsets = [int(offset) for offset in column_offset.split(",")] if column_offset else []

    for sheet in wb:
        sheet_name = sheet.title
        if filter_sheetname and sheet_name not in filter_sheetname:
            if debug:
                print(f"Skipping: {sheet_name}")
            continue

        printed_sheetname = False

        for rowidx, row in enumerate(sheet.iter_rows(), start=1):
            for colidx, cellv in enumerate(row, start=1):
                cell = cellv.value
                if cell is None:
                    continue

                if "Algo" == str(cell):
                    algoName = str(sheet[get_column_letter(colidx + 1) + str(rowidx)].value)

                cell_lower = str(cell).lower()
                if any(search_str in cell_lower for search_str in search_strings):
                    if not printed_filename:
                        if platform.system() == 'Windows':
                            fileTime = os.path.getctime(xlsx_file)
                            print(f"{colored('FRMT:', 'yellow')} , created: {time.ctime(fileTime)}")
                        printed_filename = True

                    if not printed_sheetname:
                        print(colored('\tSheetname:', 'yellow'), f" {sheet_name}")
                        printed_sheetname = True

                    print(colored(f'\t\tCell {get_column_letter(colidx)}{rowidx}:', 'yellow'), f"<{cell_lower}>")
                    result_sheet.append([os.path.basename(xlsx_file), search_str, f"Sheet: {sheet_name}, Cell: {get_column_letter(colidx)}{rowidx}, Value: {cell_lower}"])

                    if column_offset:
                        printed_searching_for = True
                        is_cell_merged = False
                        for coloffset in column_offsets:
                            for mergedCell in sheet.merged_cells.ranges:
                                if cellv.coordinate in mergedCell:
                                    is_cell_merged = True
                                    print(f"Found Merged Cell {mergedCell.coord}:  {mergedCell.start_cell.value}")
                                    min_col, min_row, max_col, max_row = mergedCell.bounds
                                    for offsetrange in range(min_row, max_row + 1):
                                        print(f"{str(sheet[get_column_letter(colidx + coloffset) + str(offsetrange)].value)}")
                            if not is_cell_merged:
                                celloffset = sheet[get_column_letter(colidx + coloffset) + str(rowidx)].value
                                if celloffset:
                                    print(colored(f'\t\tColumn offset [{coloffset}]:', 'yellow'), f"{celloffset}")
                                    result_sheet.append([os.path.basename(xlsx_file), search_str, f"Sheet: {sheet_name}, Column Offset [{coloffset}]: {celloffset}"])

                    if search_offset and re.search(search_offset, str(cell), flags=re.IGNORECASE | re.MULTILINE):
                        print(f"\t\tFound offset <{cell}> in Cell {get_column_letter(colidx)}{rowidx}")
                        result_sheet.append([os.path.basename(xlsx_file), search_str, f"Sheet: {sheet_name}, Found Offset in Cell {get_column_letter(colidx)}{rowidx}, Value: {cell}"])

                    if print_algoName and algoName:
                        print(f"\t\tAlgorithm: {algoName} | Cell {get_column_letter(colidx)}{rowidx}: <{cell}>")
                        result_sheet.append([os.path.basename(xlsx_file), search_str, f"Sheet: {sheet_name}, Algorithm: {algoName}, Cell: {get_column_letter(colidx)}{rowidx}, Value: {cell}"])

    wb.close()

def search_multiple_strings(xlsx_file, search_strings_list, output_file, column_offset=None, search_offset=None, print_algoName=None, date_calc=None, filter_sheetname=None, debug=False):
    result_wb = Workbook()
    result_sheet = result_wb.active
    result_sheet.title = "Search Results"
    result_sheet.append(["File"] + search_strings_list)

    for search_str in search_strings_list:
        print(f"Searching for: {search_str}")
        search_xlsx_beta(xlsx_file, search_str, result_sheet, column_offset=column_offset, search_offset=search_offset, print_algoName=print_algoName, date_calc=date_calc, filter_sheetname=filter_sheetname, debug=debug)

    result_wb.save(output_file)

# Example usage
# search_xlsx_beta("example.xlsx", "search_term", result_sheet, column_offset="1,2", search_offset="pattern", print_algoName=True, filter_sheetname=["Sheet1"], debug=True)
# search_multiple_strings("example.xlsx", ["search_term1", "search_term2"], "output.xlsx", column_offset="1,2", search_offset="pattern", print_algoName=True, filter_sheetname=["Sheet1"], debug=True)
